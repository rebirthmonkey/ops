# Generated by Terragrunt. Sig: nIlQXj57tbuaRZEa
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - base
patches:
  - target:
      kind: Service
      name: tam-lab-app2
    patch: |
      kind: Service
      metadata:
        name: tam-lab-app2
        annotations:
          service.kubernetes.io/tke-existed-lbid: lb-7wg4xzbf
          service.cloud.tencent.com/direct-access: "true"


  - target:
      kind: Deployment
      name: tam-lab-app2
    patch: |
      kind: Deployment
      metadata:
        name: tam-lab-app2
      spec:
        template:
          spec:
            containers:
              - name: app2
                image: nanjing-tamlab-1.tencentcloudcr.com/images/app2:v0.0.1

  - target:
      kind: ConfigMap
      name: tam-lab-app2
    patch: |
      kind: ConfigMap
      metadata:
        name: tam-lab-app2
      data:
        config.yaml: |
          swagger:
            enabled: true
          database:
            endpoint: mysql.zzzzzz-overseasops.com
            port: 3306
            username: root
            password: P@ssw0rd
            name: app2
            config: utf8&parseTime=True&loc=Local

          redis:
            hostAddresses: redis.zzzzzz-overseasops.com:6379
            password: P@ssw0rd

  - target:
      kind: Job
      name: init-mysql-app2
    patch: |
      kind: Job
      metadata:
        name: init-mysql-app2
      spec:
        template:
          spec:
            containers:
              - name: mysql
                command:
                  - sh
                  - -c
                  - |
                    while [ 1 ];
                    do
                      if mysql -h mysql.zzzzzz-overseasops.com -u root -pP@ssw0rd -e "show databases;"
                      then
                        mysql -h mysql.zzzzzz-overseasops.com -u root -pP@ssw0rd  < /data/init.sql
                        break
                      else
                        sleep 2
                      fi
                    done
